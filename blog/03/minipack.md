## é€šè¿‡å®ç°ä¸€ä¸ªç®€æ˜“æ‰“åŒ…å·¥å…·ï¼Œåˆ†ææ‰“åŒ…çš„æ ¸å¿ƒåŸç†

#### æ¦‚è¿°
çœ¼ä¸‹wepackä¼¼ä¹å·²ç»æˆäº†å‰ç«¯å¼€å‘ä¸­ä¸å¯ç¼ºå°‘çš„å·¥å…·ä¹‹ä¸€ï¼Œè€Œä»–çš„ä¸€åˆ‡çš†æ¨¡å—çš„æ€æƒ³éšç€webpackç‰ˆæœ¬ä¸æ–­çš„è¿­ä»£ï¼ˆwebpack 4ï¼‰ä½¿å…¶æ‰“åŒ…é€Ÿåº¦æ›´å¿«ï¼Œæ•ˆç‡æ›´é«˜çš„ä¸ºæˆ‘ä»¬çš„å‰ç«¯å·¥ç¨‹åŒ–æœåŠ¡
![webpack](./webpackimg.png)
ç›¸ä¿¡å¤§å®¶ä½¿ç”¨webpackå·²ç»å¾ˆç†Ÿç»ƒäº†ï¼Œä»–é€šè¿‡ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œå…¶ä¸­åŒ…æ‹¬å¯¹å…¥å£ï¼Œå‡ºå£ï¼Œæ’ä»¶çš„é…ç½®ç­‰ï¼Œç„¶åå†…éƒ¨æ ¹æ®è¿™ä¸ªé…ç½®å¯¹è±¡å»å¯¹æ•´ä¸ªé¡¹ç›®å·¥ç¨‹è¿›è¡Œæ‰“åŒ…ï¼Œä»ä¸€ä¸ªjsæ–‡ä»¶åˆ‡å…¥(æ­¤ä¸ºå•å…¥å£ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è®¾ç½®å¤šå…¥å£æ–‡ä»¶æ‰“åŒ…),å°†è¯¥æ–‡ä»¶ä¸­æ‰€æœ‰çš„ä¾èµ–çš„æ–‡ä»¶é€šè¿‡ç‰¹å®šçš„loaderå’Œæ’ä»¶éƒ½ä¼šæŒ‰ç…§æˆ‘ä»¬çš„éœ€æ±‚ä¸ºæˆ‘ä»¬æ‰“åŒ…å‡ºæ¥ï¼Œè¿™æ ·åœ¨é¢å¯¹å½“å‰çš„ES6ã€scssã€lessã€postcsså°±å¯ä»¥ç•…å¿«çš„å°½ç®¡ä½¿ç”¨ï¼Œæ‰“åŒ…å·¥å…·ä¼šå¸®åŠ©æˆ‘ä»¬è®©ä»–ä»¬æ­£ç¡®çš„è¿è¡Œåœ¨æµè§ˆå™¨ä¸Šã€‚å¯è°“æ˜¯çœæ—¶çœåŠ›è¿˜çœå¿ƒå•Šã€‚

é‚£å½“ä¸‹çš„æ‰“åŒ…å·¥å…·çš„æ ¸å¿ƒåŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä»Šå¤©å°±æ¥é€šè¿‡æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªå°å°çš„æ‰“åŒ…å·¥å…·æ¥ä¸ºæ¢ç©¶ä¸€ä¸‹ä»–çš„æ ¸å¿ƒåŸç†å–½ã€‚æ–‡ä¸­æœ‰äº›çŸ¥è¯†æ˜¯ç‚¹åˆ°ï¼Œæ²¡æœ‰æ·±æŒ–ï¼Œå¦‚æœæœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥é˜…èµ„æ–™ã€‚
> åŠŸåŠ›å°šæµ…ï¼Œåªæ˜¯å…¥é—¨çº§çš„äº†è§£æ‰“åŒ…å·¥å…·çš„æ ¸å¿ƒåŸç†ï¼Œç®€å•çš„åŠŸèƒ½

#### é¡¹ç›®åœ°å€
MiniPackï¼š[ç‚¹å‡»github]([http](https://github.com/liuchengying/MiniPack)) 
#### åŸç†

å½“æˆ‘ä»¬æ›´åŠ æ·±å…¥çš„å»äº†è§£javascriptè¿™é—¨è¯­è¨€æ—¶ï¼Œå»çŸ¥é“javascriptæ›´åº•å±‚çš„ä¸€äº›å®ç°ï¼Œå¯¹æˆ‘ä»¬ç†è§£å¥½çš„å¼€æºé¡¹ç›®æ˜¯ç”±å¾ˆå¤šå¸®åŠ©çš„ï¼Œå½“ç„¶å¯¹æˆ‘ä»¬è‡ªèº«æŠ€æœ¯æé«˜ä¼šæœ‰æ›´å¤§çš„å¸®åŠ©ã€‚
javascriptæ˜¯ä¸€é—¨å¼±ç±»å‹çš„è§£é‡Šå‹è¯­è¨€ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æˆ‘ä»¬æ‰§è¡Œå‰ä¸éœ€è¦ç¼–è¯‘å™¨æ¥ç¼–è¯‘å‡ºä¸€ä¸ªç‰ˆæœ¬ä¾›æˆ‘ä»¬æ‰§è¡Œï¼Œå¯¹äºjavascriptæ¥è¯´ä¹Ÿæœ‰ç¼–è¯‘çš„è¿‡ç¨‹ï¼Œåªä¸è¿‡å¤§éƒ¨åˆ†æƒ…å†µä¸‹ç¼–è¯‘å‘ç”Ÿåœ¨ä»£ç æ‰§è¡Œå‰çš„å‡ å¾®ç§’ï¼Œç¼–è¯‘å®Œæˆåä¼šå°½å¿«çš„æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯æ ¹æ®ä»£ç çš„æ‰§è¡Œå»åŠ¨æ€çš„ç¼–è¯‘ã€‚è€Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­é€šè¿‡è¯­æ³•å’Œè¯æ³•çš„åˆ†æå¾—å‡ºä¸€é¢—è¯­æ³•æ ‘ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒç§°ä¸º**AST**ã€**æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼‰ä¹Ÿç§°ä¸ºASTè¯­æ³•æ ‘ï¼ŒæŒ‡çš„æ˜¯æºä»£ç è¯­æ³•æ‰€å¯¹åº”çš„æ ‘çŠ¶ç»“æ„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ç§ç¼–ç¨‹è¯­è¨€çš„æºä»£ç ï¼Œé€šè¿‡æ„å»ºè¯­æ³•æ ‘çš„å½¢å¼å°†æºä»£ç ä¸­çš„è¯­å¥æ˜ å°„åˆ°æ ‘ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚**ã€‘ã€‚è€Œè¿™ä¸ªASTå´æ°æ°ä½¿æˆ‘ä»¬åˆ†ææ‰“åŒ…å·¥å…·çš„é‡ç‚¹æ ¸å¿ƒã€‚

æˆ‘ä»¬éƒ½ç†Ÿæ‚‰babelï¼Œä»–è®©å‰ç«¯ç¨‹åºå‘˜å¾ˆçˆ½çš„åœ°æ–¹åœ¨äºä»–å¯ä»¥è®©æˆ‘ä»¬ç•…å¿«çš„å»ä¹¦å†™ES6ã€ES7ã€ES8.....ç­‰ç­‰ï¼Œè€Œä»–ä¼šå¸®æˆ‘ä»¬ç»Ÿç»Ÿéƒ½è½¬æˆæµè§ˆå™¨èƒ½å¤Ÿæ‰§è¡Œçš„ES5ç‰ˆæœ¬ï¼Œå®ƒçš„æ ¸å¿ƒå°±æ˜¯é€šè¿‡ä¸€ä¸ª**babylon**çš„jsè¯æ³•è§£æå¼•æ“æ¥åˆ†ææˆ‘ä»¬å†™çš„ES6ä»¥ä¸Šçš„ç‰ˆæœ¬è¯­æ³•æ¥å¾—åˆ°AST(æŠ½è±¡è¯­æ³•æ ‘)ï¼Œå†é€šè¿‡å¯¹è¿™ä¸ªè¯­æ³•æ ‘çš„æ·±åº¦éå†æ¥å¯¹è¿™æ£µæ ‘çš„ç»“æ„å’Œæ•°æ®è¿›è¡Œä¿®æ”¹ã€‚æœ€ç»ˆè½¬é€šè¿‡æ•´ç†å’Œä¿®æ”¹åçš„ASTç”ŸæˆES5çš„è¯­æ³•ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨babelçš„ä¸»è¦æ ¸å¿ƒã€‚ä¸€ä¸‹æ˜¯è¯­æ³•æ ‘çš„ç¤ºä¾‹

**éœ€è¦è½¬æ¢çš„æ–‡ä»¶ï¼ˆindex.jsï¼‰**
``` javascript
    // es6  index.js
    import add from './add.js'
    let sum = add(1, 2);
    export default sum
    // ndoe build.js
    const fs = require('fs')
    const babylon = require('babylon')

    // è¯»å–æ–‡ä»¶å†…å®¹
    const content = fs.readFileSync(filePath, 'utf-8')
    // ç”Ÿæˆ AST é€šè¿‡babylon
    const ast = babylon.parse(content, {
        sourceType: 'module'
    })
    console.log(ast)
```
**æ‰§è¡Œæ–‡ä»¶(åœ¨nodeç¯å¢ƒä¸‹build.js)**
``` javascript
    // node build.js
    // å¼•å…¥fs å’Œ babylonå¼•æ“
    const fs = require('fs')
    const babylon = require('babylon')

    // è¯»å–æ–‡ä»¶å†…å®¹
    const content = fs.readFileSync(filePath, 'utf-8')
    // ç”Ÿæˆ AST é€šè¿‡babylon
    const ast = babylon.parse(content, {
        sourceType: 'module'
    })
    console.log(ast)
```
**ç”Ÿæˆçš„AST**
``` javascript
    ast = {
        ...
        ...
        comments:[],
        tokens:[Token {
                    type: [KeywordTokenType],
                    value: 'import',
                    start: 0,
                    end: 6,
                    loc: [SourceLocation] },
                Token {
                    type: [TokenType],
                    value: 'add',
                    start: 7,
                    end: 10,
                    loc: [SourceLocation] },
                Token {
                    type: [TokenType],
                    value: 'from',
                    start: 11,
                    end: 15,
                    loc: [SourceLocation] },
                Token {
                    type: [TokenType],
                    value: './add.js',
                    start: 16,
                    end: 26,
                    loc: [SourceLocation] },
                Token {
                    type: [KeywordTokenType],
                    value: 'let',
                    start: 27,
                    end: 30,
                    loc: [SourceLocation] },
                Token {
                    type: [TokenType],
                    value: 'sum',
                    start: 31,
                    end: 34,
                    loc: [SourceLocation] },
                ...
                ...
                Token {
                    type: [KeywordTokenType],
                    value: 'export',
                    start: 48,
                    end: 54,
                    loc: [SourceLocation] },
                Token {
                    type: [KeywordTokenType],
                    value: 'default',
                    start: 55,
                    end: 62,
                    loc: [SourceLocation] },
                Token {
                    type: [TokenType],
                    value: 'sum',
                    start: 63,
                    end: 66,
                    loc: [SourceLocation] },
            ]
   }
```
ä¸Šé¢çš„ç¤ºä¾‹å°±æ˜¯åˆ†æå‡ºæ¥çš„ASTè¯­æ³•æ ‘ã€‚**babylon**åœ¨åˆ†ææºä»£ç çš„æ—¶å€™ï¼Œä¼šé€ä¸ªå­—æ¯çš„åƒæ‰«ææœºä¸€æ ·è¯»å–ï¼Œç„¶ååˆ†æå¾—å‡ºè¯­æ³•æ ‘ã€‚(å…³äºè¯­æ³•æ ‘å’Œbabylonå¯ä»¥å‚è€ƒ https://www.jianshu.com/p/019d449a9282 ã€‚é€šè¿‡éå†å¯¹ä»–çš„å±æ€§æˆ–è€…å€¼è¿›è¡Œä¿®æ”¹æ ¹æ®ç›¸åº”çš„ç®—æ³•è§„åˆ™é‡æ–°ç»„æˆä»£ç ã€‚å½“åˆ†ææˆ‘ä»¬æ­£å¸¸çš„jsæ–‡ä»¶æ—¶ï¼Œå¾€å¾€å¾—åˆ°çš„ASTä¼šå¾ˆå¤§ç”šè‡³å‡ ä¸‡ã€å‡ åä¸‡è¡Œï¼Œæ‰€ä»¥éœ€è¦å¾ˆä¼˜ç§€çš„ç®—æ³•æ‰èƒ½ä¿è¯é€Ÿåº¦å’Œæ•ˆç‡ã€‚ä¸‹é¢æœ¬é¡¹ç›®ä¸­ç”¨åˆ°çš„æ˜¯**babel-traverse**æ¥è§£æASTã€‚å¯¹ç®—æ³•çš„æ„Ÿå…´è¶£çš„å¯ä»¥å»äº†è§£ä¸€ä¸‹ã€‚ä»¥ä¸Šéƒ¨åˆ†è®²è¿°çš„çŸ¥è¯†ç‚¹å¹¶æ²¡æœ‰æ·±å…¥ï¼ŒåŸå› å¦‚é¢˜ç›®ï¼Œåªæ˜¯è¦æ¢ç´¢å‡ºæ‰“åŒ…å·¥å…·çš„åŸç†ï¼Œå…·ä½“çŸ¥è¯†ç‚¹æ„Ÿå…´è¶£çš„è‡ªå·±å»äº†è§£ä¸‹å§ã€‚åŸç†éƒ¨åˆ†å¤§æ¦‚ä»‹ç»åˆ°è¿™é‡Œå§ï¼Œä¸‹é¢å¼€å§‹æ–½å®æˆ˜ã€‚

## é¡¹ç›®ç›®å½•
```
    â”œâ”€â”€ README.md
    â”œâ”€â”€ package.json
    â”œâ”€â”€ src
    â”‚Â Â  â”œâ”€â”€ lib
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ bundle.js // ç”Ÿæˆæ‰“åŒ…åçš„æ–‡ä»¶
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ getdep.js // ä»ASTä¸­è·å¾—æ–‡ä»¶ä¾èµ–å…³ç³»
    â”‚Â Â  â”‚Â Â  â””â”€â”€ readcode.js //è¯»å–æ–‡ä»¶ä»£ç ï¼Œç”ŸæˆASTï¼Œå¤„ç†AST,å¹¶ä¸”è½¬æ¢ES6ä»£ç 
    â”‚Â Â  â””â”€â”€ pack.js // å‘å¤–æš´éœ²å·¥å…·å…¥å£æ–¹æ³•
    â””â”€â”€ yarn.lock
```
**æ€ç»´å¯¼å›¾**
![æ€ç»´å¯¼å›¾](./siweidaotu.png)
é€šè¿‡æ€ç»´å¯¼å›¾å¯ä»¥æ›´æ¸…æ¥šç½—åˆ—å‡ºæ¥æ€è·¯
## å…·ä½“å®ç°
æµç¨‹æ¢³ç†ä¸­å‘ç°ï¼Œé‡ç‚¹æ˜¯æ‰¾åˆ°æ¯ä¸ªæ–‡ä»¶ä¸­çš„ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬ç”¨**deps**æ¥æ”¶é›†ä¾èµ–ã€‚ä»è€Œé€šè¿‡ä¾èµ–å…³ç³»æ¥æ¨¡å—åŒ–çš„æŠŠä¾èµ–å…³ç³»ä¸­ä¸€å±‚ä¸€å±‚çš„æ‰“åŒ…ã€‚ä¸‹é¢ä¸€æ­¥æ­¥çš„æ¥å®ç°
> ä¸»è¦é€šè¿‡ ä»£ç  + è§£é‡Š çš„æ¢³ç†è¿‡ç¨‹
#### è¯»å–æ–‡ä»¶ä»£ç 
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…¥å£æ–‡ä»¶çš„è·¯å¾„ï¼Œé€šè¿‡nodeçš„fsæ¨¡å—æ¥è¯»å–æŒ‡å®šæ–‡ä»¶ä¸­çš„ä»£ç ï¼Œç„¶åé€šè¿‡ä»¥ä¸Šæåˆ°çš„babylonæ¥åˆ†æä»£ç å¾—åˆ°ASTè¯­æ³•æ ‘ï¼Œç„¶åé€šè¿‡babel-traverseåº“æ¥ä»ASTä¸­è·å¾—ä»£ç ä¸­å«æœ‰importçš„æ¨¡å—(è·¯å¾„)ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–å…³ç³»ã€‚æˆ‘ä»¬æŠŠå½“å‰æ¨¡å—çš„æ‰€æœ‰ä¾èµ–æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„éƒ½pushåˆ°ä¸€ä¸ªdepsçš„æ•°ç»„ä¸­ã€‚ä»¥ä¾¿åé¢å»éå†æŸ¥æ‰¾ä¾èµ–ã€‚
``` javascript
    const fs = require('fs')
    // åˆ†æå¼•æ“
    const babylon = require('babylon')
    // traverse å¯¹è¯­æ³•æ ‘éå†ç­‰æ“ä½œ
    const traverse = require('babel-traverse').default
    // babelæä¾›çš„è¯­æ³•è½¬æ¢
    const { transformFromAst } = require('babel-core')
    // è¯»å–æ–‡ä»¶ä»£ç å‡½æ•°
    const readCode = function (filePath) {
        if(!filePath) {
            throw new Error('No entry file path')
            return
        }
        // å½“å‰æ¨¡å—çš„ä¾èµ–æ”¶é›†
        const deps = []
        const content = fs.readFileSync(filePath, 'utf-8')
        const ast = babylon.parse(content, { sourceType: 'module' })
        // åˆ†æASTï¼Œä»ä¸­å¾—åˆ°importçš„æ¨¡å—ä¿¡æ¯ï¼ˆè·¯å¾„ï¼‰
        // å…¶ä¸­ImportDeclarationæ–¹æ³•ä¸ºå½“éå†åˆ°importæ—¶çš„ä¸€ä¸ªå›è°ƒ
        traverse(ast, {
            ImportDeclaration: ({ node }) => {
                // å°†ä¾èµ–pushåˆ°depsä¸­
                // å¦‚æœæœ‰å¤šä¸ªä¾èµ–ï¼Œæ‰€ä»¥ç”¨æ•°ç»„
                deps.push(node.source.value)
            }
        })
        // es6 è½¬åŒ–ä¸º es5
        const {code} = transformFromAst(ast, null, {presets: ['env']})
        // è¿”å›ä¸€ä¸ªå¯¹è±¡
        // æœ‰è·¯å¾„ï¼Œä¾èµ–ï¼Œè½¬åŒ–åçš„es5ä»£ç 
        // ä»¥åŠä¸€ä¸ªæ¨¡å—çš„idï¼ˆè‡ªå®šä¹‰ï¼‰
        return {
            filePath,
            deps,
            code,
            id: deps.length > 0 ? deps.length - 1 : 0
        }
}

module.exports = readCode
```
ç›¸ä¿¡ä¸Šè¿°ä»£ç æ˜¯å¯ä»¥ç†è§£çš„ï¼Œä»£ç ä¸­çš„æ³¨é‡Šå†™çš„å¾ˆè¯¦ç»†ï¼Œè¿™é‡Œå°±ä¸åœ¨å¤šå•°å—¦äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œbabel-traverseè¿™ä¸ªåº“å…³äºapiä»¥åŠè¯¦ç»†çš„ä»‹ç»å¾ˆå°‘ï¼Œå¯ä»¥é€šè¿‡å…¶ä»–é€”å¾„å»äº†è§£è¿™ä¸ªåº“çš„ç”¨æ³•ã€‚
å¦å¤–éœ€è¦åœ¨å¼ºè°ƒä¸€ä¸‹çš„æ˜¯æœ€åå‡½æ•°çš„è¿”å›å€¼ï¼Œæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸­åŒ…å«çš„æ˜¯å½“å‰è¿™ä¸ªæ–‡ä»¶ï¼ˆæ¨¡å—ï¼‰ä¸­çš„ä¸€äº›é‡è¦ä¿¡æ¯ï¼Œdepsä¸­å­˜æ”¾çš„å°±æ˜¯å½“å‰æ¨¡å—åˆ†æå¾—åˆ°çš„æ‰€æœ‰ä¾èµ–æ–‡ä»¶è·¯å¾„ã€‚æœ€åæˆ‘ä»¬éœ€è¦å»é€’å½’éå†æ¯ä¸ªæ¨¡å—çš„æ‰€æœ‰ä¾èµ–ï¼Œä»¥åŠä»£ç ã€‚åé¢çš„ä¾èµ–æ”¶é›†çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚
#### ä¾èµ–æ”¶é›†
é€šè¿‡ä¸Šé¢çš„è¯»å–æ–‡ä»¶æ–¹æ³•æˆ‘ä»¬å¾—åˆ°è¿”å›äº†ä¸€ä¸ªå…³äºå•ä¸ªæ–‡ä»¶(æ¨¡å—)çš„ä¸€äº›é‡è¦ä¿¡æ¯ã€‚**filePath**(æ–‡ä»¶è·¯å¾„),**deps**(è¯¥æ¨¡å—çš„æ‰€æœ‰ä¾èµ–),**code**(è½¬åŒ–åçš„ä»£ç ),**id**(è¯¥å¯¹è±¡æ¨¡å—çš„id)
æˆ‘ä»¬é€šè¿‡å®šä¹‰**deps**ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ¥å­˜æ”¾æ‰€æœ‰ä¾èµ–å…³ç³»ä¸­æ¯ä¸€ä¸ªæ–‡ä»¶(æ¨¡å—)çš„ä»¥ä¸Šé‡è¦ä¿¡æ¯å¯¹è±¡
æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡è¿™ä¸ªå•æ–‡ä»¶å…¥å£çš„ä¾èµ–å…³ç³»å»æœé›†è¯¥æ¨¡å—çš„ä¾èµ–æ¨¡å—çš„ä¾èµ–ï¼Œä»¥åŠè¯¥æ¨¡å—çš„ä¾èµ–æ¨¡å—çš„ä¾èµ–æ¨¡å—çš„ä¾èµ–......æˆ‘ä»¬é€šè¿‡é€’å½’å’Œå¾ªç¯çš„æ–¹å¼å»æ‰§è¡ŒreadCodeæ–¹æ³•ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡å°†readCodeè¿”å›çš„å¯¹è±¡pushåˆ°depsæ•°ç»„ä¸­ï¼Œæœ€ç»ˆå¾—åˆ°äº†æ‰€æœ‰çš„åœ¨ä¾èµ–å…³ç³»é“¾ä¸­çš„æ¯ä¸€ä¸ªæ¨¡å—çš„é‡è¦ä¿¡æ¯ä»¥åŠä¾èµ–ã€‚
``` javascript
    const readCode = require('./readcode.js')
    const fs = require('fs')
    const path = require('path')
    const getDeps = function (entry) {
        // é€šè¿‡è¯»å–æ–‡ä»¶åˆ†æè¿”å›çš„ä¸»å…¥å£æ–‡ä»¶æ¨¡å—çš„é‡è¦ä¿¡æ¯  å¯¹è±¡
        const entryFileObject = readCode(entry)
        // deps ä¸ºæ¯ä¸€ä¸ªä¾èµ–å…³ç³»æˆ–è€…æ¯ä¸€ä¸ªæ¨¡å—çš„é‡è¦ä¿¡æ¯å¯¹è±¡ åˆæˆçš„æ•°ç»„
        // deps å°±æ˜¯æˆ‘ä»¬æåˆ°çš„æœ€ç»ˆçš„æ ¸å¿ƒæ•°æ®ï¼Œé€šè¿‡ä»–æ¥æ„å»ºæ•´ä¸ªæ‰“åŒ…æ–‡ä»¶
        const deps = [entryFileObject ? entryFileObject : null]
        // å¯¹depsè¿›è¡Œéå† 
        // æ‹¿åˆ°filePathä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯cssæ–‡ä»¶è¿˜æ˜¯jsæ–‡ä»¶
        for (let obj of deps) {
            const dirname = path.dirname(obj.filePath)
            obj.deps.forEach(rPath => {
                const aPath = path.join(dirname, rPath)
                if (/\.css/.test(aPath)) {
                    // å¦‚æœæ˜¯cssæ–‡ä»¶ï¼Œåˆ™ä¸è¿›è¡Œé€’å½’readCodeåˆ†æä»£ç ï¼Œ
                    // ç›´æ¥å°†ä»£ç æ”¹å†™æˆé€šè¿‡jsæ“ä½œå†™å…¥åˆ°styleæ ‡ç­¾ä¸­
                    const content = fs.readFileSync(aPath, 'utf-8')
                    const code = `
                    var style = document.createElement('style')
                    style.innerText = ${JSON.stringify(content).replace(/\\r\\n/g, '')}
                    document.head.appendChild(style)
                    `
                    deps.push({
                        filePath: aPath,
                        reletivePaht: rPath,
                        deps,
                        code,
                        id: deps.length > 0 ? deps.length : 0
                    })
                } else {
                    // å¦‚æœæ˜¯jsæ–‡ä»¶  åˆ™ç»§ç»­è°ƒç”¨readCodeåˆ†æè¯¥ä»£ç 
                    let obj = readCode(aPath)
                    obj.reletivePaht = rPath
                    obj.id = deps.length > 0 ? deps.length : 0
                    deps.push(obj)
                }
            })
        }
        // è¿”å›deps
        return deps
    }

module.exports = getDeps
```
å¯èƒ½åœ¨ä¸Šè¿°ä»£ç ä¸­æœ‰ç–‘é—®ä¹Ÿè®¸æ˜¯åœ¨å¯¹depséå†æ”¶é›†å…¨éƒ¨ä¾èµ–çš„æ—¶å€™ï¼Œåˆå¾ªç¯åˆé‡å¤è°ƒç”¨çš„å¯èƒ½æœ‰ä¸€ç‚¹ç»•ï¼Œè¿˜æœ‰ä¸€ç‚¹å¯èƒ½å°±æ˜¯å¯¹äºdepsè¿™ä¸ªæ•°ç»„æœ€åç©¶ç«Ÿè¦å¹²ä»€ä¹ˆç”¨ï¼Œæ²¡å…³ç³»ï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼Œåé¢å°±ä¼šæ‡‚äº†ã€‚
#### è¾“å‡ºæ–‡ä»¶
åˆ°ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥æ‹¿åˆ°äº†æ‰€æœ‰æ–‡ä»¶ä»¥åŠå¯¹åº”çš„ä¾èµ–ä»¥åŠæ–‡ä»¶ä¸­çš„è½¬æ¢åçš„ä»£ç ä»¥åŠidï¼Œæ˜¯çš„ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€èŠ‚ä¸­è¿”å›çš„**deps**ï¼ˆå°±é å®ƒäº†ï¼‰,å¯èƒ½åœ¨ä¸Šä¸€èŠ‚è¿˜ä¼šæœ‰äººäº§ç”Ÿç–‘é—®ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ç›´æ¥ä¸Šä»£ç ï¼Œæ…¢æ…¢é“æ¥æ…¢æ…¢è§£å¼€ä½ çš„ç–‘æƒ‘ã€‚
``` javascript
    const fs = require('fs')
    // å‹ç¼©ä»£ç çš„åº“   
    const uglify = require('uglify-js')
    // å››ä¸ªå‚æ•°
    // 1. æ‰€æœ‰ä¾èµ–çš„æ•°ç»„   ä¸Šä¸€èŠ‚ä¸­è¿”å›å€¼
    // 2. ä¸»å…¥å£æ–‡ä»¶è·¯å¾„
    // 3. å‡ºå£æ–‡ä»¶è·¯å¾„
    // 4. æ˜¯å¦å‹ç¼©è¾“å‡ºæ–‡ä»¶çš„ä»£ç 
    // ä»¥ä¸Šä¸‰ä¸ªå‚æ•°ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªdepsä¹‹å¤–ï¼Œå…¶ä»–ä¸‰ä¸ªéƒ½éœ€è¦åœ¨è¯¥é¡¹ç›®ä¸»å…¥å£æ–¹æ³•ä¸­ä¼ å…¥å‚æ•°ï¼Œé…ç½®å¯¹è±¡
    const bundle = function (deps, entry, outPath, isCompress) {
        let modules = ''
        let moduleId
        deps.forEach(dep => {
            var id = dep.id
            // é‡ç‚¹æ¥äº†
            // æ­¤å¤„ï¼Œé€šè¿‡depsçš„æ¨¡å—ã€Œidã€ä½œä¸ºå±æ€§ï¼Œè€Œå…¶å±æ€§å€¼ä¸ºä¸€ä¸ªå‡½æ•°
            // å‡½æ•°ä½“ä¸º å½“å‰éå†åˆ°çš„æ¨¡å—çš„ã€Œcodeã€ï¼Œä¹Ÿå°±æ˜¯è½¬æ¢åçš„ä»£ç 
            // äº§ç”Ÿä¸€ä¸ªé•¿å­—ç¬¦
            // 0ï¼šfunction(......){......},
            // 1: function(......){......}
            // ...
            modules = modules + `${id}: function (module, exports, require) {${dep.code}},`
        });
        // è‡ªæ‰§è¡Œå‡½æ•°ï¼Œä¼ å…¥çš„åˆšæ‰æ‹¼æ¥çš„å¯¹è±¡ï¼Œä»¥åŠdeps
        // å…¶ä¸­requireä½¿æˆ‘ä»¬è‡ªå®šä¹‰çš„,æ¨¡æ‹Ÿcommonjsä¸­çš„æ¨¡å—åŒ–
        let result = `
            (function (modules, mType) {
                function require (id) {
                    var module = { exports: {}}
                    var module_id = require_moduleId(mType, id)
                    modules[module_id](module, module.exports, require)
                    return module.exports
                }
                require('${entry}')
            })({${modules}},${JSON.stringify(deps)});
            function require_moduleId (typelist, id) {
                var module_id
                typelist.forEach(function (item) {
                    if(id === item.filePath || id === item.reletivePaht){
                        module_id = item.id
                    }
                })
                return module_id
            }
        `
        // åˆ¤æ–­æ˜¯å¦å‹ç¼©
        if(isCompress) {
            result = uglify.minify(result,{ mangle: { toplevel: true } }).code
        }
        // å†™å…¥æ–‡ä»¶ è¾“å‡º
        fs.writeFileSync(outPath + '/bundle.js', result)
        console.log('æ‰“åŒ…å®Œæˆã€successã€‘ï¼ˆ./bundle.jsï¼‰')
    }

    module.exports = bundle
```
è¿™é‡Œè¿˜æ˜¯è¦åœ¨è¯¦ç»†çš„å™è¿°ä¸€ä¸‹ã€‚å› ä¸ºæˆ‘ä»¬è¦è¾“å‡ºæ–‡ä»¶ï¼Œé¡¾å‡ºç°äº†å¤§é‡çš„å­—ç¬¦ä¸²ã€‚
**è§£é‡Š1ï¼šmoduleså­—ç¬¦ä¸²**
moduleså­—ç¬¦ä¸²æœ€åé€šè¿‡éå†depså¾—åˆ°çš„å­—ç¬¦ä¸²ä¸º
``` javascript
    modules = `
        0ï¼šfunction (module, module.exports, require){ç›¸åº”æ¨¡å—çš„ä»£ç },
        1: function (module, module.exports, require){ç›¸åº”æ¨¡å—çš„ä»£ç },
        2: function (module, module.exports, require){ç›¸åº”æ¨¡å—çš„ä»£ç },
        3: function (module, module.exports, require){ç›¸åº”æ¨¡å—çš„ä»£ç },
        ...
        ...
    `
```
å¦‚æœæˆ‘ä»¬åœ¨å­—ç¬¦ä¸²çš„ä¸¤ç«¯åˆ†åˆ«åŠ ä¸Šâ€{â€œå’Œâ€}â€œï¼Œå¦‚æœå½“æˆä»£ç æ‰§è¡Œçš„è¯é‚£ä¸å°±æ˜¯ä¸€ä¸ªå¯¹è±¡äº†å—ï¼Ÿå¯¹å•Šï¼Œè¿™æ ·0ï¼Œ1ï¼Œ2ï¼Œ3...å°±å˜æˆäº†å±æ€§ï¼Œè€Œå±æ€§çš„å€¼å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡å±æ€§ç›´æ¥è°ƒç”¨å‡½æ•°äº†ã€‚è€Œè¿™ä¸ªå‡½æ•°çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬éœ€è¦æ‰“åŒ…çš„æ¯ä¸ªæ¨¡å—çš„ä»£ç ç»è¿‡babelè½¬æ¢ä¹‹åçš„ä»£ç å•Šã€‚
**è§£é‡Š2ï¼šresultå­—ç¬¦ä¸²**
``` javascript
    // è‡ªæ‰§è¡Œå‡½æ•° å°†ä¸Šé¢çš„moduleså­—ç¬¦ä¸²åŠ ä¸Š{}åä¼ å…¥ï¼ˆå¯¹è±¡ï¼‰
    (function (modules, mType) {
        // è‡ªå®šä¹‰requireå‡½æ•°ï¼Œæ¨¡æ‹Ÿcommonjsä¸­çš„æ¨¡å—åŒ–
        function require (id) {
            // å®šä¹‰moduleå¯¹è±¡ï¼Œä»¥åŠä»–çš„exportså±æ€§
            var module = { exports: {}}
            // è½¬åŒ–è·¯å¾„å’Œidï¼Œå·²è°ƒç”¨ç›¸å…³å‡½æ•°
            var module_id = require_moduleId(mType, id)
            // è°ƒç”¨ä¼ è¿›æ¥moduleså¯¹è±¡çš„å±æ€§çš„å‡½æ•°
            modules[module_id](module, module.exports, require)
            return module.exports
        }
        require('${entry}')
    })({${modules}},${JSON.stringify(deps)});

    // è·¯å¾„å’Œidå¯¹åº”è½¬æ¢ï¼Œç›®çš„æ˜¯ä¸ºäº†è°ƒç”¨ç›¸åº”è·¯å¾„ä¸‹å¯¹åº”çš„idå±æ€§çš„å‡½æ•°
    function require_moduleId (typelist, id) {
        var module_id
        typelist.forEach(function (item) {
            if(id === item.filePath || id === item.reletivePaht){
                module_id = item.id
            }
        })
        return module_id
    }
```
è‡³äºä¸ºä»€ä¹ˆæˆ‘ä»¬è¦é€šè¿‡require_modulesIdå‡½æ•°æ¥è½¬æ¢è·¯å¾„å’Œidçš„å…³ç³»å‘¢ï¼Œè¿™è¦å…ˆä»babelå§ES6è½¬æˆES5è¯´èµ·ï¼Œä¸‹é¢åˆ—å‡ºä¸€ä¸ªES6è½¬ES5çš„ä¾‹å­

**ES6ä»£ç **ï¼š
``` javascript
    import a from './a.js'
    let b = a + a
    export default b
```
**ES5ä»£ç **ï¼š
``` javascript
    'use strict';

    Object.defineProperty(exports, "__esModule", {
        value: true
    });

    var _a = require('./a.js');

    var _a2 = _interopRequireDefault(_a);
    function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
    var b = _a2.default + _a2.default;
    
    exports.default = b;
```
1.ä»¥ä¸Šä»£ç ä¸ºè½¬åŒ–å‰å’Œè½¬æ¢åï¼Œæœ‰å…´è¶£çš„å¯ä»¥å»[babelå®˜ç½‘](https://www.babeljs.cn/repl/#?babili=false&browsers=&build=&builtIns=false&code_lz=JYWwDg9gTgLgBAQzgMyhEcDkA6A9A7AKwGdMAoAGwFN4AjOAXkTgGpEyqAPSWOAEyrIEAVwp0gA&debug=false&forceAllTransforms=false&shippedProposals=false&circleciRepo=&evaluate=true&fileSize=false&lineWrap=false&presets=latest%2Creact%2Cstage-2&prettier=false&targets=&version=6.26.0&envVersion=)è¯•è¯•ï¼Œå¯ä»¥å‘ç°è½¬æ¢åçš„è¿™ä¸€è¡Œä»£ç **var _a = require('./a.js');**ï¼Œä»–ä¸ºæˆ‘ä»¬è½¬æ¢å‡ºæ¥çš„requireçš„å‚æ•°æ˜¯æ–‡ä»¶çš„è·¯å¾„ï¼Œè€Œæˆ‘ä»¬éœ€è¦è°ƒç”¨çš„ç›¸å¯¹åº”çš„æ¨¡å—çš„å‡½æ•°å…¶å±æ€§å€¼éƒ½æ˜¯ä»¥id(0,1,2,3...)å‘½åçš„ï¼Œæ‰€ä»¥éœ€è¦è½¬æ¢
2.è¿˜æœ‰ä¸€ç‚¹å¯èƒ½æœ‰ç–‘é—®çš„å°±æ˜¯ä¸ºä»€ä¹ˆä¼šç”¨function (module, module.exports, require){...}è¿™æ ·çš„commonjsæ¨¡å—åŒ–çš„å½¢å¼å‘¢ï¼ŒåŸå› æ˜¯babelä¸ºæˆ‘ä»¬è½¬ååçš„ä»£ç æ¨¡å—åŒ–é‡‡ç”¨çš„å°±æ˜¯commonjsçš„è§„èŒƒã€‚

## æœ€å
æœ€åä¸€æ­¥å°±æ˜¯æˆ‘ä»¬å»å°è£…ä¸€ä¸‹ï¼Œå‘å¤–æš´éœ²ä¸€ä¸ªå…¥å£å‡½æ•°å°±å¯ä»¥äº†ã€‚è¿™ä¸€æ­¥æ•ˆä»¿ä¸€ä¸‹webpackçš„apiï¼Œä¸€ä¸ªpackæ–¹æ³•ä¼ å…¥ä¸€ä¸ªconfigé…ç½®å¯¹è±¡ã€‚è¿™æ ·å°±å¯ä»¥åœ¨package.jsonä¸­å†™scriptsè„šæœ¬æ¥npm/yarnæ¥æ‰§è¡Œäº†ã€‚
``` javascript
    const getDeps = require('./lib/getdep')
    const bundle = require('./lib/bundle')

    const pack = function (config) {
    if(!config.entryPath || !config.outPath) {
        throw new Error('packå·¥å…·ï¼šè¯·é…ç½®å…¥å£å’Œå‡ºå£è·¯å¾„')
        return
    }
    let entryPath = config.entryPath
    let outPath = config.outPath
    let isCompress = config.isCompression || false

    let deps = getDeps(entryPath)
    bundle(deps, entryPath, outPath, isCompress)

}

module.exports = pack
```
ä¼ å…¥çš„configåªæœ‰æ˜¯ä¸‰ä¸ªå±æ€§ï¼ŒentryPathï¼ŒoutPathï¼ŒisCompressionã€‚

-----------------------
## æ€»ç»“
ä¸€ä¸ªç®€å•çš„å®ç°ï¼Œåªä¸ºäº†æ¢ç©¶ä¸€ä¸‹åŸç†ï¼Œå¹¶æ²¡æœ‰å®Œå–„çš„åŠŸèƒ½å’Œç¨³å®šæ€§ã€‚å¸Œæœ›å¯¹çœ‹åˆ°çš„äººèƒ½æœ‰å¸®åŠ©

æ‰“åŒ…å·¥å…·ï¼Œé¦–å…ˆé€šè¿‡æˆ‘ä»¬ä»£ç æ–‡ä»¶è¿›è¡Œè¯æ³•å’Œè¯­æ³•çš„åˆ†æï¼Œç”ŸæˆASTï¼Œå†é€šè¿‡å¤„ç†ASTï¼Œæœ€ç»ˆå˜æ¢æˆæˆ‘ä»¬æƒ³è¦çš„ä»¥åŠæµè§ˆå™¨èƒ½å…¼å®¹çš„ä»£ç ï¼Œæ”¶é›†æ¯ä¸€ä¸ªæ–‡ä»¶çš„ä¾èµ–ï¼Œæœ€ç»ˆå½¢æˆä¸€ä¸ªä¾èµ–é“¾ï¼Œç„¶åé€šè¿‡è¿™ä¸ªä¾èµ–å…³ç³»æœ€åè¾“å‡ºæ‰“åŒ…åçš„æ–‡ä»¶ã€‚

åˆæ¥ä¹åˆ°ï¼Œç¨³é‡æœ‰è§£é‡Šä¸å½“æˆ–é”™çš„åœ°æ–¹ï¼Œè¿˜è¯·å¤šç†è§£ï¼Œæœ‰é—®é¢˜å¯ä»¥åœ¨è¯„è®ºåŒºäº¤æµã€‚è¿˜æœ‰åˆ«å¿˜äº†ä½ çš„ğŸ‘...